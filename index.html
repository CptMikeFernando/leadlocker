<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0078d7" />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LeadLocker - Business Card Photo Capture</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    text-align: center;
  }
  /* Main camera preview sized as business card */
  video {
    width: 350px;
    height: 200px;
    border-radius: 8px;
    border: 1px solid #ccc;
    display: block;
    margin: 0 auto;
    object-fit: cover;
  }
  #captureBtn {
    margin-top: 10px;
    padding: 10px 16px;
    font-size: 1rem;
    background-color: #0078d7;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    width: 350px;
    max-width: 100%;
    display: block;
    margin: 0 auto;
  }
  #captureBtn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  #photos {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(175px, 1fr));
    gap: 12px;
    justify-content: center;
  }
  .photo-item {
    position: relative;
    width: 175px;
    border: 1px solid #ccc;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .photo-item:hover {
    box-shadow: 0 0 8px #0078d7;
  }
  .photo-item img {
    width: 175px;
    height: 100px;
    object-fit: cover;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #ccc;
    display: block;
    pointer-events: none;
  }
  .delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(255,255,255,0.9);
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-weight: bold;
    color: #b00;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 20px;
    text-align: center;
    padding: 0;
    z-index: 10;
  }
  .edit-btn {
    margin: 6px 0;
    padding: 4px 10px;
    font-size: 0.85rem;
    background-color: #0078d7;
    border: none;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }
  .name-company {
    padding: 6px 8px 10px;
    text-align: center;
    width: 100%;
    box-sizing: border-box;
  }
  .person-name {
    font-weight: bold;
    font-size: 1rem;
    color: #222;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .company-name {
    font-size: 0.85rem;
    color: #555;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0,0,0,0.8);
    align-items: center;
    justify-content: center;
  }
  #modal img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 0 16px #000;
  }
  #modalClose {
    position: fixed;
    top: 16px;
    right: 20px;
    font-size: 30px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    user-select: none;
  }
  #inputModal {
    display: none;
    position: fixed;
    z-index: 1100;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px 30px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 400px;
    text-align: left;
  }
  #inputModal h2 { margin-top:0; margin-bottom:15px; font-weight:bold; text-align:center; }
  #inputModal label { display:block; margin-bottom:5px; font-weight:bold; }
  #inputModal input[type="text"] { width:100%; padding:8px; margin-bottom:15px; font-size:1rem; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
  #inputModalButtons { display:flex; justify-content:flex-end; gap:10px; }
  #inputModalButtons button { padding:8px 14px; font-size:1rem; border-radius:6px; border:none; cursor:pointer; }
  #saveBtn { background-color:#0078d7; color:white; }
  #cancelBtn { background-color:#ccc; color:#333; }
</style>
</head>
<body>

<h1>LeadLocker</h1>

<video autoplay playsinline></video>
<button id="captureBtn">Capture Business Card</button>

<h2>Business Cards</h2>
<div id="photos"></div>

<div id="modal">
  <span id="modalClose">&times;</span>
  <img src="" alt="Enlarged Business Card" />
</div>

<div id="inputModal">
  <h2>Enter Details</h2>
  <label for="personNameInput">Person's Name:</label>
  <input type="text" id="personNameInput" placeholder="Enter person's name" />
  <label for="companyNameInput">Company Name:</label>
  <input type="text" id="companyNameInput" placeholder="Enter company name" />
  <div id="inputModalButtons">
    <button id="cancelBtn">Cancel</button>
    <button id="saveBtn">Save</button>
  </div>
</div>

<script>
  const video = document.querySelector("video");
  const captureBtn = document.getElementById("captureBtn");
  const photosDiv = document.getElementById("photos");
  const modal = document.getElementById("modal");
  const modalImg = modal.querySelector("img");
  const modalClose = document.getElementById("modalClose");
  const inputModal = document.getElementById("inputModal");
  const personNameInput = document.getElementById("personNameInput");
  const companyNameInput = document.getElementById("companyNameInput");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");

  let db;
  let dbReady = false;
  let cards = [];
  let pendingCard = null;
  let editingCardId = null;

  async function setupCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    } catch (err) {
      alert("Error accessing camera: " + err.message);
    }
  }

  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("LeadLockerDB", 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains("cards")) {
          db.createObjectStore("cards", { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = e => {
        db = e.target.result;
        dbReady = true;
        resolve();
      };
      request.onerror = e => reject(e.target.error);
    });
  }

  function saveCardToDB(card) {
    return new Promise((resolve, reject) => {
      if (!dbReady) return reject("DB not ready");
      const tx = db.transaction("cards", "readwrite");
      const store = tx.objectStore("cards");
      const req = card.id ? store.put(card) : store.add(card);
      req.onsuccess = e => {
        if (!card.id) card.id = e.target.result;
        resolve(card);
      };
      req.onerror = e => reject(e.target.error);
    });
  }

  function deleteCardFromDB(id) {
    return new Promise((resolve, reject) => {
      if (!dbReady) return reject("DB not ready");
      const tx = db.transaction("cards", "readwrite");
      const store = tx.objectStore("cards");
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = e => reject(e.target.error);
    });
  }

  function loadCardsFromDB() {
    return new Promise((resolve, reject) => {
      if (!dbReady) return reject("DB not ready");
      const tx = db.transaction("cards", "readonly");
      const store = tx.objectStore("cards");
      const req = store.getAll();
      req.onsuccess = e => resolve(e.target.result);
      req.onerror = e => reject(e.target.error);
    });
  }

  function captureImage() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);
    return canvas.toDataURL("image/jpeg", 0.9);
  }

  function addCardToDOM(card) {
    const div = document.createElement("div");
    div.className = "photo-item";
    div.dataset.id = card.id;

    const img = document.createElement("img");
    img.src = card.image;
    div.appendChild(img);

    const nameCompanyDiv = document.createElement("div");
    nameCompanyDiv.className = "name-company";

    const pn = document.createElement("div");
    pn.className = "person-name";
    pn.textContent = card.name || "Unknown";

    const cn = document.createElement("div");
    cn.className = "company-name";
    cn.textContent = card.company || "";

    nameCompanyDiv.append(pn, cn);
    div.appendChild(nameCompanyDiv);

    const editBtn = document.createElement("button");
    editBtn.className = "edit-btn";
    editBtn.textContent = "Edit";
    editBtn.onclick = e => {
      e.stopPropagation();
      editingCardId = card.id;
      openInputModal(card);
    };
    div.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.className = "delete-btn";
    delBtn.textContent = "Ã—";
    delBtn.onclick = async e => {
      e.stopPropagation();
      if (confirm("Delete this card?")) {
        await deleteCardFromDB(card.id);
        cards = cards.filter(c => c.id !== card.id);
        photosDiv.removeChild(div);
      }
    };
    div.appendChild(delBtn);

    div.onclick = () => {
      modalImg.src = card.image;
      modal.style.display = "flex";
    };

    photosDiv.appendChild(div);
  }

  function openInputModal(card) {
    personNameInput.value = card.name || "";
    companyNameInput.value = card.company || "";
    inputModal.style.display = "block";
  }

  function closeInputModal() {
    inputModal.style.display = "none";
    pendingCard = null;
  }

  async function saveInputModal() {
    const name = personNameInput.value.trim();
    const company = companyNameInput.value.trim();

    if (!name) {
      alert("Please enter the person's name.");
      return;
    }

    if (pendingCard) {
      pendingCard.name = name;
      pendingCard.company = company;
      pendingCard = await saveCardToDB(pendingCard);
      cards.push(pendingCard);
      addCardToDOM(pendingCard);
      pendingCard = null;
    } else {
      const card = cards.find(c => c.id === editingCardId);
      if (!card) {
        closeInputModal();
        return;
      }
      card.name = name;
      card.company = company;
      await saveCardToDB(card);
      const cardDiv = photosDiv.querySelector(`.photo-item[data-id=\"${card.id}\"]`);
      cardDiv.querySelector(".person-name").textContent = name;
      cardDiv.querySelector(".company-name").textContent = company;
    }

    editingCardId = null;
    closeInputModal();
  }

  async function handleCapture() {
    pendingCard = { image: captureImage(), name: "", company: "" };
    openInputModal(pendingCard);
  }

  async function init() {
    await openDB();
    cards = await loadCardsFromDB();
    cards.forEach(addCardToDOM);
    await setupCamera();
  }

  captureBtn.onclick = handleCapture;
  cancelBtn.onclick = () => closeInputModal();
  saveBtn.onclick = saveInputModal;
  modalClose.onclick = () => { modal.style.display = "none"; modalImg.src = ""; };
  modal.onclick = e => { if (e.target === modal) { modal.style.display = "none"; modalImg.src = ""; } };

  init();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js');
    });
  }
</script>

</body>
</html>
